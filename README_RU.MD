# Terraform-конфигурация для K3s кластера в AWS

Этот проект разворачивает готовую к работе, экономичную и безопасную инфраструктуру в AWS для запуска Kubernetes кластера на базе K3s. Инфраструктура включает в себя всё необходимое: от сетевой изоляции до инстансов для кластера и безопасного доступа.

## Архитектура

Инфраструктура состоит из следующих компонентов:

- **VPC**: Изолированная сеть в AWS (`10.0.0.0/16`).
- **Подсети**:
    - **2 Публичные подсети**: Для ресурсов, которым нужен прямой доступ из интернета (Bastion Host, NAT Instance).
    - **2 Приватные подсети**: Для K3s нод (сервер и агент), которые изолированы от прямого доступа извне для повышения безопасности.
- **Маршрутизация**:
    - **Internet Gateway**: Предоставляет доступ в интернет для публичных подсетей.
    - **NAT Instance**: **(Ключевая экономия!)** Вместо дорогого NAT Gateway используется EC2-инстанс `t4g.nano` (входит в Free Tier) для предоставления доступа в интернет ресурсам в приватных подсетях.
- **Вычислительные ресурсы (EC2)**:
    - **Bastion Host**: "Прыжковый" сервер в публичной подсети для безопасного SSH-доступа к другим инстансам в приватных подсетях.
    - **K3s Server**: Мастер-нода кластера K3s в приватной подсети.
    - **K3s Agent**: Рабочая нода кластера K3s в приватной подсети.
- **Безопасность**:
    - **Security Groups**: Настроены правила для ограничения трафика между компонентами по принципу наименьших привилегий. Доступ по SSH к бастиону разрешен только с вашего IP.
    - **IAM & OpenID Connect (OIDC)**: Настроен IAM-роль для безопасной аутентификации GitHub Actions в AWS без использования долгоживущих ключей доступа.
- **Terraform State**:
    - **S3 Bucket**: Для хранения файла состояния Terraform. Включено версионирование и шифрование.
    - **DynamoDB Table**: Для блокировки файла состояния, что предотвращает конфликты при одновременном запуске Terraform.

## Начало работы

### Требования

1.  **AWS Account**: Аккаунт AWS.
2.  **Terraform**: Установленный Terraform (версия 1.6+).
3.  **AWS CLI**: Установленный и настроенный AWS CLI.
4.  **GitHub Repository**: Репозиторий на GitHub для хранения кода и настройки CI/CD.

### Настройка и развертывание

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <your-repo-url>
    cd <your-repo-dir>
    ```

2.  **Настройте переменные:**
    - Откройте файл `terraform.tfvars`.
    - Укажите ваш `github_owner` (имя пользователя или организации на GitHub).
    - Укажите ваш `my_ip` (ваш публичный IP-адрес) для доступа к бастиону. Узнать его можно, например, командой `curl ifconfig.me`.

3.  **Инициализация Terraform:**
    ```bash
    terraform init
    ```

4.  **Проверка плана:**
    ```bash
    terraform plan
    ```
    Просмотрите ресурсы, которые будут созданы.

5.  **Применение конфигурации:**
    ```bash
    terraform apply --auto-approve
    ```
    Дождитесь завершения создания всех ресурсов. В `outputs` будут выведены все необходимые IP-адреса и инструкции.

## Доступ к кластеру K3s

Все команды для доступа к кластеру выводятся в `output "kubectl_access_instructions"`.

**Пошаговая инструкция:**

1.  **Подключитесь к бастиону:**
    ```bash
    ssh -i your-key.pem ec2-user@<bastion_public_ip>
    ```
    *Замените `your-key.pem` на путь к вашему приватному ключу и `<bastion_public_ip>` на IP из вывода Terraform.*

2.  **С бастиона скопируйте kubeconfig с K3s сервера:**
    ```bash
    ssh -i your-key.pem ec2-user@<k3s_server_private_ip> "sudo cat /etc/rancher/k3s/k3s.yaml" > k3s.yaml
    ```
    *Замените `<k3s_server_private_ip>` на IP из вывода Terraform.*

3.  **Отредактируйте `k3s.yaml` на бастионе:**
    Замените `127.0.0.1` на приватный IP K3s сервера.
    ```bash
    sed -i 's/127.0.0.1/<k3s_server_private_ip>/' k3s.yaml
    ```

4.  **Проверьте работу кластера с бастиона:**
    ```bash
    export KUBECONFIG=./k3s.yaml
    kubectl get nodes
    ```
    Вы должны увидеть 2 ноды: сервер и агент.

## Развертывание Jenkins (Задание 4)

После того как кластер поднят и доступен, вы можете развернуть Jenkins с помощью Helm.

1.  **Установите Helm**, если он еще не установлен.

2.  **Добавьте репозиторий Jenkins:**
    ```bash
    helm repo add jenkins [https://charts.jenkins.io](https://charts.jenkins.io)
    helm repo update
    ```

3.  **Создайте namespace для Jenkins:**
    ```bash
    kubectl create namespace jenkins
    ```

4.  **Установите Jenkins:**
    ```bash
    helm install jenkins jenkins/jenkins -n jenkins
    ```

5.  **Получите пароль администратора:**
    ```bash
    kubectl exec --namespace jenkins -it svc/jenkins -c jenkins -- /bin/cat /var/jenkins_home/secrets/initialAdminPassword
    ```

6.  **Сделайте Jenkins доступным:**
    Для доступа к Jenkins UI с вашего локального компьютера, пробросьте порт через бастион:
    ```bash
    # На вашем локальном компьютере в новом терминале
    ssh -i your-key.pem -N -L 8080:<k3s_server_private_ip>:8080 ec2-user@<bastion_public_ip>
    ```
    Теперь Jenkins будет доступен в браузере по адресу `http://localhost:8080`.

## CI/CD с GitHub Actions

В репозитории настроен workflow (`.github/workflows/terraform.yml`), который использует OIDC для безопасной аутентификации в AWS. Он автоматически выполняет `terraform plan` для Pull Request'ов и `terraform apply` при слиянии в `main` ветку.
